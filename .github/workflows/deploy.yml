# Deploy DocsAI to EC2 (34.201.10.84)
# Trigger: push to main, or manual (workflow_dispatch)
# Secrets: EC2_SSH_PRIVATE_KEY, EC2_HOST, EC2_USER

name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to deploy"
        type: string
        required: false
        default: "main"

env:
  PROJECT_DIR: /var/www/docsai

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Setup SSH
        env:
          SSH_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy on EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          BRANCH: ${{ github.event.inputs.branch || (github.event_name == 'push' && github.ref_name) || 'main' }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o BatchMode=yes "$EC2_USER@$EC2_HOST" \
            "set -e && cd ${{ env.PROJECT_DIR }} && git fetch origin && git reset --hard origin/$BRANCH && bash deploy/remote-deploy.sh"

      - name: Verify deployment
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          sleep 5
          curl -sf --connect-timeout 10 "http://$EC2_HOST/api/v1/health/" || true
